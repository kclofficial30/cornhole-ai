<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KCA AI ë¹„ë””ì˜¤ ë¦¬í¬íŠ¸ v10.0</title>
    <style>
        :root { --red: #d63031; --blue: #0984e3; --dark: #000000; --green: #00b894; --yellow: #f1c40f; }
        body { margin: 0; background: #f1f2f6; font-family: 'Pretendard', sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .header { background: var(--dark); padding: 10px; text-align: center; }
        .header img { height: 30px; }

        /* ëŒ€ì‹œë³´ë“œ ì§€í‘œ */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; padding: 10px; background: #fff; border-bottom: 2px solid #ddd; }
        .stat-box { background: #f8f9fa; padding: 8px; border-radius: 8px; text-align: center; border-bottom: 3px solid #ccc; }
        .label { font-size: 10px; color: #636e72; font-weight: bold; }
        .val { font-size: 1.1rem; font-weight: 800; }

        /* ë·°ì–´ ì˜ì—­ */
        .view-container { position: relative; flex: 1; background: #000; overflow: hidden; }
        video, canvas { position: absolute; width: 100%; height: 100%; object-fit: contain; }

        /* í•˜ë‹¨ íŒ¨ë„ */
        .ui-panel { background: #fff; padding: 10px; border-top: 1px solid #ddd; overflow-y: auto; max-height: 45vh; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        .btn { padding: 15px; border: none; border-radius: 10px; font-weight: bold; font-size: 0.9rem; color: white; cursor: pointer; }
        .btn-rec { background: var(--red); } /* ë…¹í™” ë²„íŠ¼ */
        .btn-stop { background: var(--dark); display: none; } /* ë…¹í™” ì¤‘ì§€ */
        .btn-cap { background: var(--blue); } /* ë¦´ë¦¬ì¦ˆ íƒ€ì´ë° ìº¡ì²˜ */
        
        /* ë°¸ëŸ°ìŠ¤ ê²½ê³ ë“± */
        #balance-indicator { font-size: 10px; font-weight: bold; margin-bottom: 5px; text-align: center; }
        .balance-ok { color: var(--green); }
        .balance-bad { color: var(--red); }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
</head>
<body>

<div class="header"><img src="https://www.cornhole.kr/html/img/logo.png" alt="KCA"></div>

<div class="dashboard">
    <div class="stat-box"><div class="label">íŒ” ê°ë„</div><div class="val" id="angle-val">0Â°</div></div>
    <div class="stat-box"><div class="label">ì¢Œìš° ë°¸ëŸ°ìŠ¤</div><div class="val" id="balance-val">0Â°</div></div>
    <div class="stat-box"><div class="label">ë¦´ë¦¬ì¦ˆ íƒ€ì´ë°</div><div class="val" id="timing-val">-</div></div>
</div>

<div class="view-container">
    <video id="input_video" playsinline muted crossorigin="anonymous"></video>
    <canvas id="output_canvas"></canvas>
</div>

<div class="ui-panel">
    <div id="balance-indicator">ì‹ ì²´ ê· í˜• ë¶„ì„ ì¤‘...</div>
    
    <div class="btn-grid">
        <button id="rec-start" class="btn btn-rec" onclick="startRecording()">ğŸ”´ ë¶„ì„ ì˜ìƒ ë…¹í™” ì‹œì‘</button>
        <button id="rec-stop" class="btn btn-stop" onclick="stopRecording()">â¹ ë…¹í™” ì¤‘ì§€ ë° ì €ì¥</button>
        <button class="btn btn-cap" onclick="markRelease()">ğŸ¯ ë¦´ë¦¬ì¦ˆ ì‹œì  ê³ ì •</button>
    </div>

    <input type="file" id="video-upload" accept="video/*" style="width: 100%; margin: 10px 0;">
    
    <button class="btn" style="background:var(--green); width: 100%;" onclick="exportData()">ğŸ“Š ë¶„ì„ ë°ì´í„° ì—‘ì…€ ì €ì¥</button>

    <div style="font-size: 11px; color: #888; margin-top: 10px; line-height: 1.4;">
        * ë¦´ë¦¬ì¦ˆ ì‹œì  ê³ ì •: ì£¼ë¨¸ë‹ˆë¥¼ ë†“ëŠ” ìˆœê°„ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ê·¸ë•Œì˜ ê°ë„ê°€ ê¸°ë¡ë©ë‹ˆë‹¤.<br>
        * ë…¹í™” ê¸°ëŠ¥: AI ë¼ˆëŒ€ì™€ ê¶¤ì ì´ í¬í•¨ëœ ë¶„ì„ ì˜ìƒì´ MP4ë¡œ ì €ì¥ë©ë‹ˆë‹¤.
    </div>
</div>

<script>
    const video = document.getElementById('input_video');
    const canvas = document.getElementById('output_canvas');
    const ctx = canvas.getContext('2d');
    const fileInput = document.getElementById('video-upload');

    let currentAngle = 0, balanceAngle = 0, releaseAngle = 0;
    let analysisLog = [];
    let mediaRecorder, recordedChunks = [];

    // [AI ì„¤ì •]
    const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/${file}`});
    pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5 });
    pose.onResults(onResults);

    function calculateAngle(a, b, c) {
        const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
        let angle = Math.abs(radians * 180.0 / Math.PI);
        if (angle > 180.0) angle = 360 - angle;
        return Math.round(angle);
    }

    function onResults(results) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

        if (results.poseLandmarks) {
            const lm = results.poseLandmarks;
            
            // 1. íŒ” ê°ë„ (ì–´ê¹¨ 12, íŒ”ê¿ˆì¹˜ 14, ì†ëª© 16)
            currentAngle = calculateAngle(lm[12], lm[14], lm[16]);
            document.getElementById('angle-val').innerText = `${currentAngle}Â°`;

            // 2. ëª¸ì˜ ë°¸ëŸ°ìŠ¤ (ì–´ê¹¨ 11 - ì–´ê¹¨ 12 ìˆ˜í‰ ì²´í¬)
            const shoulderLeft = lm[11];
            const shoulderRight = lm[12];
            balanceAngle = Math.abs(Math.round((shoulderLeft.y - shoulderRight.y) * 100));
            document.getElementById('balance-val').innerText = `${balanceAngle}`;
            
            const balInd = document.getElementById('balance-indicator');
            if(balanceAngle < 5) {
                balInd.innerText = "âœ… ì‹ ì²´ ë°¸ëŸ°ìŠ¤ ì•ˆì •ì ";
                balInd.className = "balance-ok";
            } else {
                balInd.innerText = "âš ï¸ ì‹ ì²´ ê¸°ìš¸ì–´ì§ ì£¼ì˜";
                balInd.className = "balance-bad";
            }

            // 3. ìŠ¤ì¼ˆë ˆí†¤ ë° ê¶¤ì  ê·¸ë¦¬ê¸°
            drawConnectors(ctx, lm, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 3});
            drawLandmarks(ctx, lm, {color: '#FF0000', radius: 2});
        }
        ctx.restore();
    }

    // [ì˜ìƒ ë…¹í™” ë¡œì§]
    function startRecording() {
        recordedChunks = [];
        const stream = canvas.captureStream(30); // 30fpsë¡œ ìº”ë²„ìŠ¤ ìº¡ì²˜
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });

        mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = saveVideo;
        mediaRecorder.start();

        document.getElementById('rec-start').style.display = 'none';
        document.getElementById('rec-stop').style.display = 'block';
    }

    function stopRecording() {
        mediaRecorder.stop();
        document.getElementById('rec-start').style.display = 'block';
        document.getElementById('rec-stop').style.display = 'none';
    }

    function saveVideo() {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `KCA_Analysis_${new Date().getTime()}.webm`;
        a.click();
    }

    // [ë¦´ë¦¬ì¦ˆ íƒ€ì´ë° ë§ˆí‚¹]
    function markRelease() {
        releaseAngle = currentAngle;
        const timestamp = video.currentTime.toFixed(2);
        document.getElementById('timing-val').innerText = `${releaseAngle}Â° (${timestamp}s)`;
        analysisLog.push({ angle: releaseAngle, balance: balanceAngle, time: timestamp });
        alert("ë¦´ë¦¬ì¦ˆ ì‹œì  ë°ì´í„°ê°€ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) { video.src = URL.createObjectURL(file); video.play(); }
    });

    async function processFrame() {
        if (!video.paused && !video.ended) { await pose.send({image: video}); }
        requestAnimationFrame(processFrame);
    }
    video.addEventListener('play', processFrame);

    function exportData() {
        let csv = "\uFEFFë¦´ë¦¬ì¦ˆê°ë„,ëª¸ê¸°ìš¸ê¸°,ì˜ìƒì‹œì (ì´ˆ)\n";
        analysisLog.forEach(log => {
            csv += `${log.angle},${log.balance},${log.time}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "KCA_Pitching_Data.csv";
        link.click();
    }
</script>
</body>
</html>
