<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KCA AI ë¶„ì„ ë°ì´í„° ì„¼í„° v6.0</title>
    <style>
        :root { --red: #d63031; --blue: #0984e3; --dark: #000000; --yellow: #f1c40f; --green: #00b894; }
        body { margin: 0; background: #f1f2f6; font-family: 'Pretendard', sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* ë¡œê³  í—¤ë” */
        .header { background: var(--dark); padding: 12px; text-align: center; }
        .header img { height: 35px; }

        /* ë¶„ì„ ëŒ€ì‹œë³´ë“œ */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; background: #fff; border-bottom: 2px solid #ddd; }
        .stat-card { background: #f8f9fa; padding: 10px; border-radius: 8px; text-align: center; border-left: 4px solid var(--blue); }
        .stat-label { font-size: 11px; color: #636e72; font-weight: bold; }
        .stat-val { font-size: 1.5rem; font-weight: 800; color: var(--dark); }

        /* ë¹„ë””ì˜¤ ì˜ì—­ */
        .view-container { position: relative; flex: 1; background: #000; overflow: hidden; }
        video, canvas { position: absolute; width: 100%; height: 100%; object-fit: cover; }
        .mirror { transform: scaleX(-1); }

        /* ê¸°ë¡ ì»¨íŠ¸ë¡¤ */
        .controls { padding: 15px; background: #fff; display: flex; flex-direction: column; gap: 8px; }
        .row { display: flex; gap: 8px; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 10px; font-weight: bold; font-size: 1rem; cursor: pointer; color: white; }
        .btn-record { background: var(--red); }
        .btn-save { background: var(--green); }
        
        /* ë°ì´í„° ë¡œê·¸ í…Œì´ë¸” */
        .data-log { height: 120px; overflow-y: auto; background: #eee; font-size: 11px; padding: 5px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #ddd; position: sticky; top: 0; }
        td, th { padding: 5px; border: 1px solid #eee; text-align: center; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
</head>
<body>

<div class="header">
    <img src="https://www.cornhole.kr/html/img/logo.png" alt="KCA">
</div>

<div class="dashboard">
    <div class="stat-card">
        <div class="stat-label">í˜„ì¬ íŒ” ê°ë„</div>
        <div class="stat-val" id="live-angle">0Â°</div>
    </div>
    <div class="stat-card" style="border-left-color: var(--red);">
        <div class="stat-label">ìµœëŒ€ ìŠ¤ìœ™ ê°ë„</div>
        <div class="stat-val" id="max-angle">0Â°</div>
    </div>
</div>

<div class="view-container">
    <video id="input_video" playsinline muted></video>
    <canvas id="output_canvas"></canvas>
</div>

<div class="controls">
    <div class="row">
        <button class="btn btn-record" onclick="logData()">ğŸ’¾ í˜„ì¬ ìì„¸ ìˆ˜ì¹˜ ê¸°ë¡</button>
        <button class="btn btn-save" onclick="exportData()">ğŸ“Š ì—‘ì…€ ì €ì¥ (CSV)</button>
    </div>
    <div class="data-log">
        <table>
            <thead><tr><th>íšŒì°¨</th><th>ê°ë„</th><th>ì‹œê°„</th></tr></thead>
            <tbody id="log-body"></tbody>
        </table>
    </div>
</div>

<script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    
    let recordedData = [];
    let currentAngle = 0;
    let maxAngle = 0;

    // ê´€ì ˆ ì‚¬ì´ì˜ ê°ë„ë¥¼ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜
    function calculateAngle(a, b, c) {
        const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
        let angle = Math.abs(radians * 180.0 / Math.PI);
        if (angle > 180.0) angle = 360 - angle;
        return Math.round(angle);
    }

    function onResults(results) {
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

        if (results.poseLandmarks) {
            const landmarks = results.poseLandmarks;
            
            // ì˜¤ë¥¸ìª½ íŒ” ê´€ì ˆ ì¢Œí‘œ (ì–´ê¹¨: 12, íŒ”ê¿ˆì¹˜: 14, ì†ëª©: 16)
            const shoulder = landmarks[12];
            const elbow = landmarks[14];
            const wrist = landmarks[16];

            if (shoulder && elbow && wrist) {
                currentAngle = calculateAngle(shoulder, elbow, wrist);
                document.getElementById('live-angle').innerText = `${currentAngle}Â°`;
                
                if(currentAngle > maxAngle) {
                    maxAngle = currentAngle;
                    document.getElementById('max-angle').innerText = `${maxAngle}Â°`;
                }
            }

            drawConnectors(canvasCtx, landmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
            drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 2, radius: 3});
        }
        canvasCtx.restore();
    }

    const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/${file}`});
    pose.setOptions({ modelComplexity: 0, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
    pose.onResults(onResults);

    const camera = new Camera(videoElement, {
        onFrame: async () => { await pose.send({image: videoElement}); },
        width: 1280, height: 720
    });
    camera.start();

    // ë°ì´í„° ë¡œê·¸ ë‚¨ê¸°ê¸°
    function logData() {
        const time = new Date().toLocaleTimeString();
        recordedData.push({ angle: currentAngle, time: time });
        
        const row = document.getElementById('log-body').insertRow(0);
        row.innerHTML = `<td>${recordedData.length}</td><td>${currentAngle}Â°</td><td>${time}</td>`;
        maxAngle = 0; // ê¸°ë¡ í›„ ìµœëŒ€ê°ë„ ì´ˆê¸°í™”
    }

    // ì—‘ì…€ ì €ì¥
    function exportData() {
        let csv = "\uFEFFíšŒì°¨,íˆ¬êµ¬ê°ë„,ê¸°ë¡ì‹œê°„\n";
        recordedData.forEach((d, i) => {
            csv += `${i+1},${d.angle},${d.time}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "KCA_í”¼ì¹­ë¶„ì„ë°ì´í„°.csv";
        link.click();
    }
</script>
</body>
</html>
