<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KCA ê³¨í”„í˜• ì •ë°€ ë¶„ì„ê¸° v13.0</title>
    <style>
        :root { --red: #d63031; --blue: #0984e3; --dark: #000; --green: #00b894; --yellow: #f1c40f; }
        body { margin: 0; background: #f1f2f6; font-family: 'Pretendard', sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .header { background: var(--dark); padding: 10px; text-align: center; }
        .header img { height: 25px; }
        
        /* ë¶„ì„ ëŒ€ì‹œë³´ë“œ - ê³¨í”„ ë¶„ì„ê¸° ìŠ¤íƒ€ì¼ */
        .dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; padding: 10px; background: #1e272e; color: #fff; }
        .stat-box { background: #2f3640; padding: 5px; border-radius: 5px; text-align: center; }
        .label { font-size: 9px; color: #dcdde1; font-weight: bold; }
        .val { font-size: 1.1rem; font-weight: 800; color: var(--yellow); }

        .view-container { position: relative; flex: 1; background: #000; overflow: hidden; }
        video, canvas { position: absolute; width: 100%; height: 100%; object-fit: contain; }
        
        .ui-panel { background: #fff; padding: 12px; border-top: 1px solid #ddd; z-index: 100; max-height: 40vh; overflow-y: auto; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn { padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 0.9rem; cursor: pointer; color: white; }
        
        /* ê¶¤ì  ê°€ì´ë“œ ì„¤ì • */
        .guide-line { position: absolute; border: 1px dashed rgba(255,255,255,0.5); pointer-events: none; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
</head>
<body>

<div class="header"><img src="https://www.cornhole.kr/html/img/logo.png" alt="KCA"></div>

<div class="dashboard">
    <div class="stat-box"><div class="label">LIVE ANGLE</div><div class="val" id="angle-val">0Â°</div></div>
    <div class="stat-box"><div class="label">MAX BACK</div><div class="val" id="max-back">0Â°</div></div>
    <div class="stat-box"><div class="label">STANCE</div><div class="val" id="stance-val">OK</div></div>
    <div class="stat-box"><div class="label">RELEASE</div><div class="val" id="rel-val">-</div></div>
</div>

<div class="view-container" id="container">
    <video id="input_video" playsinline muted style="display:none;"></video>
    <canvas id="output_canvas"></canvas>
    <div class="guide-line" style="top:20%; bottom:20%; left:50%; width:0;"></div>
    <div class="guide-line" style="left:10%; right:10%; top:50%; height:0;"></div>
</div>

<div class="ui-panel">
    <div class="btn-grid">
        <button class="btn" style="background:var(--red); grid-column: span 2;" onclick="startAnalysis()">ğŸ”´ ë¶„ì„ ë° ë…¹í™” ì‹œì‘</button>
        <button class="btn" style="background:var(--dark)" onclick="clearCanvas()">âœ¨ ê¶¤ì  ì´ˆê¸°í™”</button>
        <button class="btn" style="background:var(--blue)" onclick="exportData()">ğŸ“Š ë°ì´í„° ì €ì¥</button>
    </div>
    <div style="margin-top:10px; font-size:11px; color:#666;">
        * íŒŒë€ìƒ‰ ê¶¤ì : ë°±ìŠ¤ìœ™ / ë¹¨ê°„ìƒ‰ ê¶¤ì : ì „ì§„ í”¼ì¹­<br>
        * ì¤‘ì•™ ê°€ì´ë“œë¼ì¸ì— ë§ì¶° ëª¸ì˜ ì¶•ì„ ê³ ì •í•˜ì„¸ìš”.
    </div>
</div>

<script>
    const video = document.getElementById('input_video');
    const canvas = document.getElementById('output_canvas');
    const ctx = canvas.getContext('2d');
    
    let backTrajectory = []; // ë°±ìŠ¤ìœ™ (íŒŒë‘)
    let forwardTrajectory = []; // í”¼ì¹­ (ë¹¨ê°•)
    let isBackswing = true;
    let prevWristY = 0;
    let maxBackAngle = 0;

    const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/${file}`});
    pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5 });

    function onResults(results) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

        if (results.poseLandmarks) {
            const lm = results.poseLandmarks;
            const wrist = lm[16]; // ì˜¤ë¥¸ì† ê¸°ì¤€
            const elbow = lm[14];
            const shoulder = lm[12];

            // 1. ê°ë„ ê³„ì‚°
            const radians = Math.atan2(wrist.y - elbow.y, wrist.x - elbow.x) - Math.atan2(shoulder.y - elbow.y, shoulder.x - elbow.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            if (angle > 180) angle = 360 - angle;
            angle = Math.round(angle);
            document.getElementById('angle-val').innerText = `${angle}Â°`;

            // 2. ë°±ìŠ¤ìœ™ vs í”¼ì¹­ ì „í™˜ ê°ì§€ (Yì¢Œí‘œ ë³€í™” ê¸°ì¤€)
            if (wrist.y > prevWristY) isBackswing = true; // ë‚´ë ¤ê°€ê±°ë‚˜ ë’¤ë¡œ ê°
            else isBackswing = false; // ìœ„ë¡œ ë˜ì§
            prevWristY = wrist.y;

            if (isBackswing && angle > maxBackAngle) {
                maxBackAngle = angle;
                document.getElementById('max-back').innerText = `${maxBackAngle}Â°`;
            }

            // 3. ê¶¤ì  ê¸°ë¡ (ìƒ‰ìƒ êµ¬ë¶„)
            const p = {x: wrist.x * canvas.width, y: wrist.y * canvas.height};
            if (isBackswing) {
                backTrajectory.push(p); if(backTrajectory.length > 30) backTrajectory.shift();
            } else {
                forwardTrajectory.push(p); if(forwardTrajectory.length > 30) forwardTrajectory.shift();
            }

            // 4. ë Œë”ë§
            drawTrajectory(backTrajectory, '#0984e3'); // íŒŒë‘
            drawTrajectory(forwardTrajectory, '#d63031'); // ë¹¨ê°•
            drawConnectors(ctx, lm, POSE_CONNECTIONS, {color: '#ffffff', lineWidth: 2});
            drawLandmarks(ctx, lm, {color: '#f1c40f', radius: 2});
        }
        ctx.restore();
    }

    function drawTrajectory(points, color) {
        if (points.length < 2) return;
        ctx.beginPath();
        ctx.moveTo(points[0].x, points[0].y);
        points.forEach(pt => ctx.lineTo(pt.x, pt.y));
        ctx.strokeStyle = color; ctx.lineWidth = 5; ctx.stroke();
    }

    const camera = new Camera(video, { onFrame: async () => { await pose.send({image: video}); }, width: 1280, height: 720 });
    camera.start();

    function clearCanvas() { backTrajectory = []; forwardTrajectory = []; maxBackAngle = 0; }
</script>
</body>
</html>
