<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KCA AI ë¹„êµ ë¶„ì„ê¸° v7.0</title>
    <style>
        :root { --red: #d63031; --blue: #0984e3; --dark: #000000; --green: #00b894; --yellow: #f1c40f; }
        body { margin: 0; background: #f1f2f6; font-family: 'Pretendard', sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .header { background: var(--dark); padding: 10px; text-align: center; }
        .header img { height: 35px; }

        /* [ë³€ê²½] ë¹„êµ ëŒ€ì‹œë³´ë“œ */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; padding: 10px; background: #fff; border-bottom: 2px solid #ddd; }
        .stat-box { background: #f8f9fa; padding: 8px; border-radius: 8px; text-align: center; border-bottom: 3px solid #ccc; }
        .label { font-size: 10px; color: #636e72; font-weight: bold; margin-bottom: 2px; }
        .val { font-size: 1.2rem; font-weight: 800; }
        .diff-plus { color: var(--red); }
        .diff-minus { color: var(--blue); }

        /* ë¹„ë””ì˜¤ ì˜ì—­ */
        .view-container { position: relative; flex: 1; background: #000; overflow: hidden; }
        video, canvas { position: absolute; width: 100%; height: 100%; object-fit: cover; }
        .mirror { transform: scaleX(-1); }

        /* ì»¨íŠ¸ë¡¤ ì˜ì—­ */
        .controls { padding: 15px; background: #fff; display: flex; flex-direction: column; gap: 10px; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn { padding: 18px; border: none; border-radius: 12px; font-weight: bold; font-size: 1rem; color: white; cursor: pointer; }
        .btn-base { background: var(--dark); } /* ê¸°ì¤€ì  ì„¤ì • */
        .btn-cap { background: var(--red); } /* í˜„ì¬ ìº¡ì²˜ */
        .btn-save { background: var(--green); width: 100%; }

        /* ê¸°ë¡ í…Œì´ë¸” */
        .log-container { height: 150px; overflow-y: auto; background: white; font-size: 11px; border-top: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; }
        th { background: #f8f9fa; position: sticky; top: 0; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
</head>
<body>

<div class="header"><img src="https://www.cornhole.kr/html/img/logo.png" alt="KCA"></div>

<div class="dashboard">
    <div class="stat-box" style="border-color: var(--dark);">
        <div class="label">ê¸°ì¤€(Standard)</div>
        <div class="val" id="base-val">0Â°</div>
    </div>
    <div class="stat-box" style="border-color: var(--red);">
        <div class="label">í˜„ì¬(Current)</div>
        <div class="val" id="curr-val">0Â°</div>
    </div>
    <div class="stat-box" style="border-color: var(--green);">
        <div class="label">ì˜¤ì°¨(Diff)</div>
        <div class="val" id="diff-val">0Â°</div>
    </div>
</div>

<div class="view-container">
    <video id="input_video" playsinline muted></video>
    <canvas id="output_canvas"></canvas>
</div>

<div class="controls">
    <div class="btn-group">
        <button class="btn btn-base" onclick="setBaseline()">ğŸ“ ê¸°ì¤€ìì„¸ ë“±ë¡</button>
        <button class="btn btn-cap" onclick="captureAndLog()">ğŸ“¸ í˜„ì¬ í”¼ì¹­ ê¸°ë¡</button>
    </div>
    <button class="btn btn-save" onclick="exportCSV()">ğŸ“Š ë¶„ì„ ë°ì´í„° ì €ì¥ (CSV)</button>
    
    <div class="log-container">
        <table>
            <thead><tr><th>íšŒì°¨</th><th>ê¸°ì¤€</th><th>ê¸°ë¡</th><th>ì˜¤ì°¨</th></tr></thead>
            <tbody id="log-body"></tbody>
        </table>
    </div>
</div>

<script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    
    let baselineAngle = 0;
    let currentAngle = 0;
    let analysisHistory = [];

    function calculateAngle(a, b, c) {
        const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
        let angle = Math.abs(radians * 180.0 / Math.PI);
        if (angle > 180.0) angle = 360 - angle;
        return Math.round(angle);
    }

    function onResults(results) {
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

        if (results.poseLandmarks) {
            const lm = results.poseLandmarks;
            // ì˜¤ë¥¸ìª½ íŒ” (12:ì–´ê¹¨, 14:íŒ”ê¿ˆì¹˜, 16:ì†ëª©)
            if(lm[12] && lm[14] && lm[16]) {
                currentAngle = calculateAngle(lm[12], lm[14], lm[16]);
                document.getElementById('curr-val').innerText = `${currentAngle}Â°`;
                
                // ì˜¤ì°¨ ì‹¤ì‹œê°„ ê³„ì‚°
                if(baselineAngle > 0) {
                    const diff = currentAngle - baselineAngle;
                    const diffDisp = document.getElementById('diff-val');
                    diffDisp.innerText = (diff > 0 ? "+" : "") + diff + "Â°";
                    diffDisp.className = "val " + (diff >= 0 ? "diff-plus" : "diff-minus");
                }
            }
            drawConnectors(canvasCtx, lm, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
            drawLandmarks(canvasCtx, lm, {color: '#FF0000', radius: 3});
        }
        canvasCtx.restore();
    }

    const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/${file}`});
    pose.setOptions({ modelComplexity: 0, smoothLandmarks: true, minDetectionConfidence: 0.5 });
    pose.onResults(onResults);

    new Camera(videoElement, {
        onFrame: async () => { await pose.send({image: videoElement}); },
        width: 1280, height: 720
    }).start();

    // [ë¡œì§] ê¸°ì¤€ì  ì„¤ì •
    function setBaseline() {
        baselineAngle = currentAngle;
        document.getElementById('base-val').innerText = `${baselineAngle}Â°`;
        alert("í˜„ì¬ ê°ë„ê°€ ê¸°ì¤€ ìì„¸ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤: " + baselineAngle + "Â°");
    }

    // [ë¡œì§] í˜„ì¬ ì‹œì  ìº¡ì²˜ ë° ë¡œê·¸ ê¸°ë¡
    function captureAndLog() {
        if(baselineAngle === 0) {
            alert("ë¨¼ì € 'ê¸°ì¤€ìì„¸ ë“±ë¡'ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.");
            return;
        }
        const diff = currentAngle - baselineAngle;
        const record = {
            base: baselineAngle,
            curr: currentAngle,
            diff: diff,
            time: new Date().toLocaleTimeString()
        };
        analysisHistory.push(record);

        const row = document.getElementById('log-body').insertRow(0);
        row.innerHTML = `<td>${analysisHistory.length}</td><td>${record.base}Â°</td><td>${record.curr}Â°</td><td class="${diff>=0?'diff-plus':'diff-minus'}">${diff > 0 ? "+" : ""}${diff}Â°</td>`;
    }

    function exportCSV() {
        let csv = "\uFEFFíšŒì°¨,ê¸°ì¤€ê°ë„,íˆ¬êµ¬ê°ë„,ì˜¤ì°¨,ê¸°ë¡ì‹œê°„\n";
        analysisHistory.forEach((d, i) => {
            csv += `${i+1},${d.base},${d.curr},${d.diff},${d.time}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "KCA_ìì„¸ë¹„êµë¶„ì„.csv";
        link.click();
    }
</script>
</body>
</html>
