<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KCA AI ì •ë°€ ë¶„ì„ê¸° v12.0</title>
    <style>
        :root { --red: #d63031; --blue: #0984e3; --dark: #000000; --green: #00b894; --yellow: #f1c40f; }
        body { margin: 0; background: #f1f2f6; font-family: 'Pretendard', sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* í—¤ë” ë° ì„¤ì • */
        .header { background: var(--dark); padding: 10px; text-align: center; }
        .header img { height: 30px; }

        .dashboard { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; padding: 10px; background: #fff; color: #333; border-bottom: 2px solid #ddd; }
        .stat-box { background: #f8f9fa; padding: 8px; border-radius: 10px; text-align: center; border-bottom: 3px solid #ddd; }
        .label { font-size: 10px; font-weight: bold; color: #666; }
        .val { font-size: 1.1rem; font-weight: 800; }

        /* ë¹„ë””ì˜¤ ì˜ì—­ */
        .view-container { position: relative; flex: 1; display: flex; align-items: center; justify-content: center; background: #000; overflow: hidden; }
        video, canvas { position: absolute; width: 100%; height: 100%; object-fit: contain; }
        .mirror { transform: scaleX(-1); }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ë° ë¡œê·¸ */
        .ui-panel { background: #fff; padding: 12px; border-top: 1px solid #ddd; z-index: 100; overflow-y: auto; max-height: 50vh; }
        
        .selection-group { display: flex; gap: 10px; margin-bottom: 10px; justify-content: center; }
        .radio-label { font-size: 14px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; }

        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .btn { padding: 15px; border: none; border-radius: 12px; font-weight: bold; font-size: 0.95rem; cursor: pointer; color: white; }
        .btn-rec { background: var(--red); grid-column: span 2; }
        .btn-stop { background: var(--dark); grid-column: span 2; animation: blink 1s infinite; }
        
        /* ì‹¤ì‹œê°„ ë°ì´í„° í…Œì´ë¸” */
        .data-table-container { margin-top: 10px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; text-align: center; background: white; }
        th { background: #f8f9fa; padding: 8px; border-bottom: 2px solid #ddd; }
        td { padding: 6px; border-bottom: 1px solid #eee; }

        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
</head>
<body>

<div class="header"><img src="https://www.cornhole.kr/html/img/logo.png" alt="KCA"></div>

<div class="dashboard">
    <div class="stat-box"><div class="label">íŒ” ê°ë„</div><div class="val" id="angle-val">0Â°</div></div>
    <div class="stat-box"><div class="label">ì„ íƒ ì†</div><div class="val" id="hand-display">ì˜¤ë¥¸ì†</div></div>
    <div class="stat-box"><div class="label">ë…¹í™”ì‹œê°„</div><div class="val" id="rec-timer">0.0s</div></div>
</div>

<div class="view-container">
    <video id="input_video" playsinline muted style="display:none;"></video>
    <canvas id="output_canvas"></canvas>
</div>

<div class="ui-panel">
    <div class="selection-group">
        <label class="radio-label"><input type="radio" name="hand" value="right" checked onchange="updateHand()"> ì˜¤ë¥¸ì† í”¼ì¹­</label>
        <label class="radio-label"><input type="radio" name="hand" value="left" onchange="updateHand()"> ì™¼ì† í”¼ì¹­</label>
    </div>

    <div class="btn-grid">
        <button id="btn-start" class="btn btn-rec" onclick="startRecording()">ğŸ”´ ë¶„ì„ ë…¹í™” ë° 0.5s ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘</button>
        <button id="btn-stop" class="btn btn-stop" onclick="stopRecording()" style="display:none;">â¹ ë…¹í™” ì¤‘ì§€ ë° CSV ì €ì¥</button>
        <button class="btn" style="background:var(--blue)" onclick="clearTrajectory()">âœ¨ ê¶¤ì  ì´ˆê¸°í™”</button>
        <button class="btn" style="background:#555" onclick="location.reload()">ğŸ”„ ì•± ë¦¬ì…‹</button>
    </div>

    <div class="data-table-container">
        <table>
            <thead><tr><th>ì‹œê°„(s)</th><th>ê°ë„(Â°)</th><th>Xì¢Œí‘œ</th><th>Yì¢Œí‘œ</th></tr></thead>
            <tbody id="data-log-body"></tbody>
        </table>
    </div>
</div>

<script>
    const video = document.getElementById('input_video');
    const canvas = document.getElementById('output_canvas');
    const ctx = canvas.getContext('2d');
    
    let trajectoryPoints = [];
    let mediaRecorder, recordedChunks = [];
    let selectedHand = 'right';
    let currentAngle = 0;
    let currentWrist = {x: 0, y: 0};
    let dataLog = [];
    let recordInterval, timerInterval;
    let startTime = 0;

    const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/${file}`});
    pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5 });

    function calculateAngle(a, b, c) {
        const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
        let angle = Math.abs(radians * 180.0 / Math.PI);
        if (angle > 180.0) angle = 360 - angle;
        return Math.round(angle);
    }

    function updateHand() {
        selectedHand = document.querySelector('input[name="hand"]:checked').value;
        document.getElementById('hand-display').innerText = selectedHand === 'right' ? 'ì˜¤ë¥¸ì†' : 'ì™¼ì†';
        clearTrajectory();
    }

    pose.onResults((results) => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

        if (results.poseLandmarks) {
            const lm = results.poseLandmarks;
            // ì¸ë±ìŠ¤ ì„¤ì • (ì™¼ì†: 11,13,15 / ì˜¤ë¥¸ì†: 12,14,16)
            const idx = selectedHand === 'right' ? [12, 14, 16] : [11, 13, 15];
            
            currentAngle = calculateAngle(lm[idx[0]], lm[idx[1]], lm[idx[2]]);
            currentWrist = { x: Math.round(lm[idx[2]].x * 100), y: Math.round(lm[idx[2]].y * 100) };
            
            document.getElementById('angle-val').innerText = `${currentAngle}Â°`;

            // ê¶¤ì  ì²˜ë¦¬
            const wrist = lm[idx[2]];
            if (wrist.visibility > 0.5) {
                trajectoryPoints.push({x: wrist.x * canvas.width, y: wrist.y * canvas.height});
                if (trajectoryPoints.length > 60) trajectoryPoints.shift();
            }

            // ê·¸ë¦¬ê¸°
            if (trajectoryPoints.length > 1) {
                ctx.beginPath(); ctx.moveTo(trajectoryPoints[0].x, trajectoryPoints[0].y);
                trajectoryPoints.forEach(p => ctx.lineTo(p.x, p.y));
                ctx.strokeStyle = '#FFD700'; ctx.lineWidth = 5; ctx.stroke();
            }
            drawConnectors(ctx, lm, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 3});
            drawLandmarks(ctx, lm, {color: '#FF0000', radius: 2});

            // í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´
            ctx.scale(-1, 1); ctx.fillStyle = "white"; ctx.font = "bold 18px sans-serif";
            ctx.fillText(`Mode: ${selectedHand === 'right' ? 'R' : 'L'}`, -canvas.width + 20, 30);
            ctx.fillText(`Angle: ${currentAngle}Â°`, -canvas.width + 20, 55);
        }
        ctx.restore();
    });

    const camera = new Camera(video, { onFrame: async () => { await pose.send({image: video}); }, width: 1280, height: 720 });
    camera.start();

    function clearTrajectory() { trajectoryPoints = []; }

    // [ë¡œì§] 0.5ì´ˆ ì£¼ê¸° ë°ì´í„° ìˆ˜ì§‘ ë° ë…¹í™”
    function startRecording() {
        recordedChunks = []; dataLog = [];
        document.getElementById('data-log-body').innerHTML = "";
        
        const types = ['video/webm;codecs=vp8', 'video/webm', 'video/mp4'];
        let sType = types.find(t => MediaRecorder.isTypeSupported(t));
        mediaRecorder = new MediaRecorder(canvas.captureStream(30), { mimeType: sType });
        mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = exportFiles;
        
        startTime = Date.now();
        mediaRecorder.start();

        // 0.5ì´ˆ ê°„ê²© ë°ì´í„° ì¶”ì¶œ
        recordInterval = setInterval(() => {
            const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
            const entry = { time: elapsed, angle: currentAngle, x: currentWrist.x, y: currentWrist.y };
            dataLog.push(entry);
            
            const row = document.getElementById('data-log-body').insertRow(0);
            row.innerHTML = `<td>${entry.time}s</td><td>${entry.angle}Â°</td><td>${entry.x}</td><td>${entry.y}</td>`;
        }, 500);

        // íƒ€ì´ë¨¸ í‘œì‹œ
        timerInterval = setInterval(() => {
            document.getElementById('rec-timer').innerText = ((Date.now() - startTime) / 1000).toFixed(1) + 's';
        }, 100);

        document.getElementById('btn-start').style.display = 'none';
        document.getElementById('btn-stop').style.display = 'block';
    }

    function stopRecording() {
        mediaRecorder.stop();
        clearInterval(recordInterval);
        clearInterval(timerInterval);
        document.getElementById('btn-start').style.display = 'block';
        document.getElementById('btn-stop').style.display = 'none';
    }

    function exportFiles() {
        // 1. ë¹„ë””ì˜¤ ì €ì¥
        const vBlob = new Blob(recordedChunks, { type: mediaRecorder.mimeType });
        const vUrl = URL.createObjectURL(vBlob);
        const vLink = document.createElement('a');
        vLink.href = vUrl; vLink.download = `Pitch_Analysis_${Date.now()}.webm`; vLink.click();

        // 2. CSV ë°ì´í„° ì €ì¥
        let csv = "\uFEFFì‹œê°„(s),ì„ íƒì†,í”¼ì¹­ê°ë„(Â°),ì†ëª©X,ì†ëª©Y\n";
        dataLog.forEach(d => {
            csv += `${d.time},${selectedHand},${d.angle},${d.x},${d.y}\n`;
        });
        const cBlob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const cUrl = URL.createObjectURL(cBlob);
        const cLink = document.createElement('a');
        cLink.href = cUrl; cLink.download = `Pitch_Data_${Date.now()}.csv`; cLink.click();
    }
</script>
</body>
</html>
