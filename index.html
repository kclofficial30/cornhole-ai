<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KCA AI ë¶„ì„ê¸° v11.0</title>
    <style>
        :root { --red: #d63031; --blue: #0984e3; --dark: #000000; --green: #00b894; --yellow: #f1c40f; }
        body { margin: 0; background: #000; color: white; font-family: 'Pretendard', sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* ìƒíƒœ ì•Œë¦¼ì°½ */
        #debug-log { background: rgba(0,0,0,0.8); color: var(--yellow); font-size: 11px; padding: 10px; text-align: center; z-index: 1000; }

        /* ë©”ì¸ ë·°ì–´ */
        .view-container { position: relative; flex: 1; display: flex; align-items: center; justify-content: center; background: #111; }
        video, canvas { position: absolute; width: 100%; height: 100%; object-fit: cover; }
        .mirror { transform: scaleX(-1); }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ */
        .ui-panel { background: #fff; padding: 15px; border-top: 1px solid #ddd; z-index: 100; color: #333; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn { padding: 18px; border: none; border-radius: 12px; font-weight: bold; font-size: 1rem; cursor: pointer; color: white; }
        .btn-cam { background: var(--blue); width: 100%; margin-bottom: 10px; }
        .btn-rec { background: var(--red); }
        .btn-stop { background: var(--dark); }

        /* ë¡œë”© ë ˆì´ì–´ */
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: #000; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index: 2000; }
        .spinner { border: 4px solid #333; border-top: 4px solid var(--yellow); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
    <p>AI ëª¨ë¸ ë° ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘...</p>
</div>

<div id="debug-log">ì¹´ë©”ë¼ ê¶Œí•œ ëŒ€ê¸° ì¤‘...</div>

<div class="view-container">
    <video id="input_video" playsinline muted autoplay></video>
    <canvas id="output_canvas"></canvas>
</div>

<div class="ui-panel">
    <button class="btn btn-cam" onclick="initCamera()">ğŸ“¸ ì¹´ë©”ë¼ ì¼œê¸° / ì¬í™œì„±í™”</button>
    
    <div class="btn-grid">
        <button id="rec-start" class="btn btn-rec" onclick="startRecording()">ğŸ”´ ë…¹í™” ì‹œì‘</button>
        <button id="rec-stop" class="btn btn-stop" onclick="stopRecording()" style="display:none;">â¹ ì¤‘ì§€ ë° ì €ì¥</button>
        <button class="btn" style="background:var(--green)" onclick="location.reload()">ğŸ”„ ì´ˆê¸°í™”</button>
    </div>
    
    <div style="margin-top:10px; font-size:11px; color:#888; text-align:center;">
        * ì•„ì´í°: Safari ë¸Œë¼ìš°ì € ê¶Œì¥ / ê°¤ëŸ­ì‹œ: Chrome ê¶Œì¥
    </div>
</div>

<script>
    const video = document.getElementById('input_video');
    const canvas = document.getElementById('output_canvas');
    const ctx = canvas.getContext('2d');
    const debugLog = document.getElementById('debug-log');
    const loadingOverlay = document.getElementById('loading-overlay');

    let camera = null;
    let mediaRecorder, recordedChunks = [];

    // AI ì„¤ì •
    const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/${file}`});
    pose.setOptions({ modelComplexity: 0, smoothLandmarks: true, minDetectionConfidence: 0.5 });
    
    pose.onResults((results) => {
        if (loadingOverlay.style.display !== 'none') {
            loadingOverlay.style.display = 'none';
            debugLog.innerText = "AI ë¶„ì„ í™œë°œí•˜ê²Œ ì‘ë™ ì¤‘";
        }
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
        if (results.poseLandmarks) {
            drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
            drawLandmarks(ctx, results.poseLandmarks, {color: '#FF0000', radius: 2});
        }
        ctx.restore();
    });

    // ì¹´ë©”ë¼ ì´ˆê¸°í™” ë° ê¶Œí•œ ìš”ì²­ í•¨ìˆ˜
    async function initCamera() {
        debugLog.innerText = "ì¹´ë©”ë¼ ì¥ì¹˜ë¥¼ ì°¾ëŠ” ì¤‘...";
        
        try {
            if (camera) { await camera.stop(); }

            camera = new Camera(video, {
                onFrame: async () => { await pose.send({image: video}); },
                facingMode: 'user', // ì „ë©´ ì¹´ë©”ë¼ (ê±°ìš¸ ëª¨ë“œ)
                width: 1280,
                height: 720
            });

            video.classList.add('mirror');
            canvas.classList.add('mirror');

            await camera.start();
            debugLog.innerText = "ì¹´ë©”ë¼ê°€ ì„±ê³µì ìœ¼ë¡œ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.";
        } catch (err) {
            debugLog.innerText = "ì˜¤ë¥˜: ì¹´ë©”ë¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆê±°ë‚˜ ì¥ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            console.error(err);
        }
    }

    // ë…¹í™” ë¡œì§
    function startRecording() {
        recordedChunks = [];
        const stream = canvas.captureStream(30);
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
        mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `KCA_Analysis_${Date.now()}.webm`; a.click();
        };
        mediaRecorder.start();
        document.getElementById('rec-start').style.display = 'none';
        document.getElementById('rec-stop').style.display = 'block';
    }

    function stopRecording() {
        mediaRecorder.stop();
        document.getElementById('rec-start').style.display = 'block';
        document.getElementById('rec-stop').style.display = 'none';
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œë„
    window.onload = initCamera;
</script>
</body>
</html>
