<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KCA AI ë§ˆìŠ¤í„° v14.0</title>
    <style>
        :root { --red: #d63031; --blue: #0984e3; --dark: #1e272e; --green: #00b894; --yellow: #f1c40f; }
        body { margin: 0; background: #f1f2f6; font-family: 'Pretendard', sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .header { background: #000; padding: 10px; text-align: center; }
        .header img { height: 25px; }
        
        /* ë¶„ì„ ëŒ€ì‹œë³´ë“œ */
        .dashboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; padding: 10px; background: var(--dark); color: #fff; }
        .stat-box { background: #2f3640; padding: 8px; border-radius: 8px; text-align: center; border-bottom: 3px solid #555; }
        .label { font-size: 10px; color: #aaa; font-weight: bold; }
        .val { font-size: 1.2rem; font-weight: 800; color: var(--yellow); }

        /* ë¹„ë””ì˜¤ ì˜ì—­ */
        .view-container { position: relative; flex: 1; background: #000; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        video, canvas { position: absolute; width: 100%; height: 100%; object-fit: contain; }
        .mirror { transform: scaleX(-1); }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .ui-panel { background: #fff; padding: 15px; border-top: 2px solid #ddd; z-index: 100; max-height: 50vh; overflow-y: auto; }
        .btn { padding: 15px; border: none; border-radius: 12px; font-weight: bold; font-size: 1rem; cursor: pointer; color: white; width: 100%; margin-bottom: 8px; }
        
        .mode-switch { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
        .btn-cam { background: var(--blue); }
        .btn-upload { background: var(--dark); }
        .btn-rec { background: var(--red); }

        /* ìŠ¬ë¡œìš° ë¹„ë””ì˜¤ ì»¨íŠ¸ë¡¤ëŸ¬ */
        .video-player-ui { background: #eee; padding: 10px; border-radius: 10px; margin-bottom: 10px; display: none; flex-direction: column; gap: 8px; }
        #seek-bar { width: 100%; height: 30px; }
        .player-btns { display: flex; gap: 5px; }
        .p-btn { flex: 1; padding: 8px; border: none; border-radius: 5px; background: #555; color: #fff; font-size: 12px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
</head>
<body>

<div class="header"><img src="https://www.cornhole.kr/html/img/logo.png" alt="KCA"></div>

<div class="dashboard">
    <div class="stat-box"><div class="label">LIVE ANGLE</div><div class="val" id="angle-val">0Â°</div></div>
    <div class="stat-box"><div class="label">MAX BACK</div><div class="val" id="max-angle">0Â°</div></div>
    <div class="stat-box"><div class="label">RELEASE</div><div class="val" id="rel-val">-</div></div>
</div>

<div class="view-container">
    <video id="input_video" playsinline muted crossorigin="anonymous"></video>
    <canvas id="output_canvas"></canvas>
</div>

<div class="ui-panel">
    <button class="btn btn-cam" onclick="startLiveCamera()">ğŸ“¸ ì‹¤ì‹œê°„ ì¹´ë©”ë¼ ì‹œì‘ (ì•„ì´í° í•„ìˆ˜)</button>

    <div class="mode-switch">
        <label class="btn btn-upload" style="text-align:center; line-height:1.2;">
            ğŸ“‚ ìŠ¬ë¡œìš° ì˜ìƒ ì„ íƒ
            <input type="file" id="video-upload" accept="video/*" style="display:none;" onchange="loadVideo(event)">
        </label>
        <button class="btn btn-rec" onclick="toggleRecording()">ğŸ”´ ë¶„ì„ ë…¹í™”</button>
    </div>

    <div class="video-player-ui" id="video-controls">
        <input type="range" id="seek-bar" value="0">
        <div class="player-btns">
            <button class="p-btn" onclick="togglePlay()">ì¬ìƒ/ì¼ì‹œì •ì§€</button>
            <button class="p-btn" onclick="changeSpeed(0.25)">0.25x</button>
            <button class="p-btn" onclick="changeSpeed(0.5)">0.5x</button>
            <button class="p-btn" onclick="changeSpeed(1)">1x</button>
        </div>
    </div>
    
    <button class="btn" style="background:var(--green)" onclick="exportCSV()">ğŸ“Š ë¶„ì„ ë°ì´í„° ì €ì¥</button>
</div>

<script>
    const video = document.getElementById('input_video');
    const canvas = document.getElementById('output_canvas');
    const ctx = canvas.getContext('2d');
    const seekBar = document.getElementById('seek-bar');
    
    let pose, camera;
    let trajectoryPoints = [];
    let isLive = true;
    let maxAngle = 0;

    // AI ì„¤ì • ì´ˆê¸°í™”
    function initAI() {
        pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/${file}`});
        pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5 });
        pose.onResults(onResults);
    }

    function onResults(results) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        if(isLive) { ctx.translate(canvas.width, 0); ctx.scale(-1, 1); }
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

        if (results.poseLandmarks) {
            const lm = results.poseLandmarks;
            // ê°ë„ ê³„ì‚° (ì˜¤ë¥¸ìª½ ì–´ê¹¨-íŒ”ê¿ˆì¹˜-ì†ëª©)
            const angle = calculateAngle(lm[12], lm[14], lm[16]);
            document.getElementById('angle-val').innerText = `${angle}Â°`;
            if(angle > maxAngle) {
                maxAngle = angle;
                document.getElementById('max-angle').innerText = `${maxAngle}Â°`;
            }

            // ê¶¤ì  (ì†ëª© 16)
            const wrist = lm[16];
            trajectoryPoints.push({x: wrist.x * canvas.width, y: wrist.y * canvas.height});
            if(trajectoryPoints.length > 50) trajectoryPoints.shift();

            // ê¶¤ì  ê·¸ë¦¬ê¸°
            ctx.beginPath();
            ctx.moveTo(trajectoryPoints[0].x, trajectoryPoints[0].y);
            trajectoryPoints.forEach(p => ctx.lineTo(p.x, p.y));
            ctx.strokeStyle = '#FFD700'; ctx.lineWidth = 5; ctx.stroke();

            drawConnectors(ctx, lm, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
            drawLandmarks(ctx, lm, {color: '#FF0000', radius: 2});
        }
        ctx.restore();
    }

    function calculateAngle(a, b, c) {
        const radians = Math.atan2(c.y-b.y, c.x-b.x) - Math.atan2(a.y-b.y, a.x-b.x);
        let angle = Math.abs(radians * 180.0 / Math.PI);
        if(angle > 180) angle = 360 - angle;
        return Math.round(angle);
    }

    // ì¹´ë©”ë¼ ì‹œì‘ (ì‚¬ìš©ì í´ë¦­ í•„ìˆ˜)
    async function startLiveCamera() {
        isLive = true;
        document.getElementById('video-controls').style.display = 'none';
        video.classList.add('mirror'); canvas.classList.add('mirror');
        
        if(!pose) initAI();
        
        camera = new Camera(video, {
            onFrame: async () => { await pose.send({image: video}); },
            width: 1280, height: 720
        });
        await camera.start();
        alert("ì‹¤ì‹œê°„ ì¹´ë©”ë¼ ë¶„ì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    // ë¹„ë””ì˜¤ íŒŒì¼ ë¡œë“œ
    function loadVideo(event) {
        const file = event.target.files[0];
        if (file) {
            isLive = false;
            video.src = URL.createObjectURL(file);
            video.classList.remove('mirror'); canvas.classList.remove('mirror');
            document.getElementById('video-controls').style.display = 'flex';
            
            if(!pose) initAI();
            video.play();
        }
    }

    // ë¹„ë””ì˜¤ ë¶„ì„ ë£¨í”„
    async function processVideoFrame() {
        if (!video.paused && !video.ended) {
            await pose.send({image: video});
            requestAnimationFrame(processVideoFrame);
        }
    }
    video.onplay = processVideoFrame;

    // í”Œë ˆì´ì–´ ì»¨íŠ¸ë¡¤
    function togglePlay() { 
        if(video.paused) video.play(); else video.pause(); 
        pose.send({image: video}); // ë©ˆì·„ì„ ë•Œë„ ë¶„ì„ ìœ ì§€
    }
    function changeSpeed(speed) { video.playbackRate = speed; }
    
    video.ontimeupdate = () => { seekBar.value = (video.currentTime / video.duration) * 100; };
    seekBar.oninput = () => { video.currentTime = (seekBar.value / 100) * video.duration; pose.send({image: video}); };

    window.onload = initAI;
</script>
</body>
</html>
