<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KCA AI ë¦¬í¬í„° v11.5</title>
    <style>
        :root { --red: #d63031; --blue: #0984e3; --dark: #000000; --green: #00b894; --yellow: #f1c40f; }
        body { margin: 0; background: #000; color: white; font-family: 'Pretendard', sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* ëŒ€ì‹œë³´ë“œ */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; padding: 10px; background: #fff; color: #333; }
        .stat-box { background: #f8f9fa; padding: 8px; border-radius: 10px; text-align: center; border-bottom: 3px solid #ddd; }
        .label { font-size: 10px; font-weight: bold; color: #666; }
        .val { font-size: 1.2rem; font-weight: 800; }

        /* ë¹„ë””ì˜¤ ì˜ì—­ */
        .view-container { position: relative; flex: 1; display: flex; align-items: center; justify-content: center; background: #111; }
        video, canvas { position: absolute; width: 100%; height: 100%; object-fit: contain; }
        .mirror { transform: scaleX(-1); }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .ui-panel { background: #fff; padding: 15px; border-top: 1px solid #ddd; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        .btn { padding: 15px; border: none; border-radius: 12px; font-weight: bold; font-size: 1rem; cursor: pointer; color: white; width: 100%; }
        .btn-rec { background: var(--red); }
        .btn-stop { background: var(--dark); animation: blink 1s infinite; }
        .btn-clear { background: var(--blue); }
        
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        #rec-status { font-size: 12px; text-align: center; color: var(--red); font-weight: bold; display: none; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
</head>
<body>

<div class="dashboard">
    <div class="stat-box"><div class="label">íŒ” ê°ë„</div><div class="val" id="angle-val">0Â°</div></div>
    <div class="stat-box"><div class="label">ìƒì²´ ë°¸ëŸ°ìŠ¤</div><div class="val" id="balance-val">0Â°</div></div>
</div>

<div class="view-container">
    <video id="input_video" playsinline muted style="display:none;"></video>
    <canvas id="output_canvas"></canvas>
</div>

<div id="rec-status">â— ë…¹í™” ì¤‘... (ë°ì´í„° í¬í•¨)</div>

<div class="ui-panel">
    <button id="btn-start" class="btn btn-rec" onclick="startRecording()">ğŸ”´ ë¶„ì„ ì˜ìƒ ë…¹í™” ì‹œì‘</button>
    <button id="btn-stop" class="btn btn-stop" onclick="stopRecording()" style="display:none;">â¹ ë…¹í™” ì¤‘ì§€ ë° ì €ì¥</button>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
        <button class="btn btn-clear" onclick="clearTrajectory()">âœ¨ ê¶¤ì  ì§€ìš°ê¸°</button>
        <button class="btn" style="background:#555" onclick="location.reload()">ğŸ”„ ì´ˆê¸°í™”</button>
    </div>
</div>

<script>
    const video = document.getElementById('input_video');
    const canvas = document.getElementById('output_canvas');
    const ctx = canvas.getContext('2d');
    
    let trajectoryPoints = [];
    let mediaRecorder, recordedChunks = [];
    let currentAngle = 0, balanceAngle = 0;

    // AI ì„¤ì •
    const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/${file}`});
    pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5 });

    function calculateAngle(a, b, c) {
        const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
        let angle = Math.abs(radians * 180.0 / Math.PI);
        if (angle > 180.0) angle = 360 - angle;
        return Math.round(angle);
    }

    pose.onResults((results) => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // ê±°ìš¸ ëª¨ë“œ ì ìš© (ì „ë©´ ì¹´ë©”ë¼ ê¸°ì¤€)
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
        
        // 1. ì›ë³¸ ì¹´ë©”ë¼ ì˜ìƒ ê·¸ë¦¬ê¸°
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

        if (results.poseLandmarks) {
            const lm = results.poseLandmarks;
            
            // 2. ìˆ˜ì¹˜ ê³„ì‚°
            currentAngle = calculateAngle(lm[12], lm[14], lm[16]);
            balanceAngle = Math.abs(Math.round((lm[11].y - lm[12].y) * 100));
            
            // UI ì—…ë°ì´íŠ¸
            document.getElementById('angle-val').innerText = `${currentAngle}Â°`;
            document.getElementById('balance-val').innerText = `${balanceAngle}`;

            // 3. ê¶¤ì  ì¶”ì  (ì†ëª© Index 16)
            const wrist = lm[16];
            if (wrist.visibility > 0.5) {
                trajectoryPoints.push({x: wrist.x * canvas.width, y: wrist.y * canvas.height});
                if (trajectoryPoints.length > 50) trajectoryPoints.shift();
            }

            // 4. í™”ë©´ì— ê·¸ë¦¬ê¸° (ë¼ˆëŒ€, ê¶¤ì , í…ìŠ¤íŠ¸)
            // ê¶¤ì  ì„ 
            if (trajectoryPoints.length > 1) {
                ctx.beginPath();
                ctx.moveTo(trajectoryPoints[0].x, trajectoryPoints[0].y);
                trajectoryPoints.forEach(p => ctx.lineTo(p.x, p.y));
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 6;
                ctx.stroke();
            }

            // ë¼ˆëŒ€
            drawConnectors(ctx, lm, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
            drawLandmarks(ctx, lm, {color: '#FF0000', radius: 2});

            // ìˆ˜ì¹˜ ì˜¤ë²„ë ˆì´ ê·¸ë¦¬ê¸° (ë…¹í™” ì˜ìƒì— í¬í•¨ì‹œí‚¤ê¸° ìœ„í•´ ìº”ë²„ìŠ¤ì— ì§ì ‘ ì”€)
            ctx.scale(-1, 1); // í…ìŠ¤íŠ¸ëŠ” ê±°ìš¸ëª¨ë“œ í•´ì œ
            ctx.fillStyle = "white";
            ctx.font = "bold 20px sans-serif";
            ctx.fillText(`Angle: ${currentAngle}Â°`, -canvas.width + 20, 40);
            ctx.fillText(`Balance: ${balanceAngle}`, -canvas.width + 20, 70);
        }
        ctx.restore();
    });

    // ì¹´ë©”ë¼ ì‹œì‘
    const camera = new Camera(video, {
        onFrame: async () => { await pose.send({image: video}); },
        width: 1280, height: 720
    });
    camera.start();

    // ê¶¤ì  ì´ˆê¸°í™”
    function clearTrajectory() { trajectoryPoints = []; }

    // [ì¤‘ìš”] ë…¹í™” ë¡œì§ ê°•í™”
    async function startRecording() {
        recordedChunks = [];
        // ìº”ë²„ìŠ¤ì—ì„œ ìŠ¤íŠ¸ë¦¼ ì¶”ì¶œ (ëª¨ë“  ë¶„ì„ ë‚´ìš© í¬í•¨)
        const stream = canvas.captureStream(30); 
        
        // ë¸Œë¼ìš°ì €ë³„ ì§€ì› ê°€ëŠ¥í•œ ì½”ë± í™•ì¸
        const types = ['video/webm;codecs=vp8', 'video/webm', 'video/mp4'];
        let supportedType = types.find(type => MediaRecorder.isTypeSupported(type));
        
        mediaRecorder = new MediaRecorder(stream, { mimeType: supportedType });

        mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: supportedType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `KCA_Analysis_${Date.now()}.${supportedType.includes('mp4') ? 'mp4' : 'webm'}`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
        };

        mediaRecorder.start();
        document.getElementById('btn-start').style.display = 'none';
        document.getElementById('btn-stop').style.display = 'block';
        document.getElementById('rec-status').style.display = 'block';
    }

    function stopRecording() {
        mediaRecorder.stop();
        document.getElementById('btn-start').style.display = 'block';
        document.getElementById('btn-stop').style.display = 'none';
        document.getElementById('rec-status').style.display = 'none';
    }
</script>
</body>
</html>
