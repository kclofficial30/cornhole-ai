<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KCA AI ë¹„ë””ì˜¤ ë¶„ì„ê¸° v8.0</title>
    <style>
        :root { --red: #d63031; --blue: #0984e3; --dark: #000000; --green: #00b894; --yellow: #f1c40f; }
        body { margin: 0; background: #f1f2f6; font-family: 'Pretendard', sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .header { background: var(--dark); padding: 10px; text-align: center; }
        .header img { height: 30px; }

        /* ëŒ€ì‹œë³´ë“œ */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; padding: 10px; background: #fff; border-bottom: 2px solid #ddd; }
        .stat-box { background: #f8f9fa; padding: 8px; border-radius: 8px; text-align: center; border-bottom: 3px solid #ccc; }
        .label { font-size: 10px; color: #636e72; font-weight: bold; }
        .val { font-size: 1.1rem; font-weight: 800; }

        /* ë¹„ë””ì˜¤ ì»¨í…Œì´ë„ˆ */
        .view-container { position: relative; flex: 1; background: #000; overflow: hidden; }
        video, canvas { position: absolute; width: 100%; height: 100%; object-fit: contain; }
        .mirror { transform: scaleX(-1); }

        /* ì…ë ¥ ì„¤ì • ë° ë¹„ë””ì˜¤ ì»¨íŠ¸ë¡¤ */
        .ui-panel { background: #fff; padding: 10px; border-top: 1px solid #ddd; }
        .file-input-group { margin-bottom: 10px; display: flex; gap: 5px; align-items: center; }
        #video-upload { flex: 1; font-size: 12px; }
        
        .vid-controls { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        #seek-bar { flex: 1; }

        /* ë²„íŠ¼ ê·¸ë£¹ */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        .btn { padding: 15px; border: none; border-radius: 10px; font-weight: bold; font-size: 0.9rem; color: white; cursor: pointer; }
        .btn-base { background: var(--dark); }
        .btn-cap { background: var(--red); }
        .btn-save { background: var(--green); width: 100%; padding: 12px; margin-top: 5px; }

        /* ë¡œê·¸ */
        .log-container { height: 100px; overflow-y: auto; background: white; font-size: 10px; border-top: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 6px; border-bottom: 1px solid #eee; text-align: center; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
</head>
<body>

<div class="header"><img src="https://www.cornhole.kr/html/img/logo.png" alt="KCA"></div>

<div class="dashboard">
    <div class="stat-box" style="border-color: var(--dark);"><div class="label">ê¸°ì¤€</div><div class="val" id="base-val">0Â°</div></div>
    <div class="stat-box" style="border-color: var(--red);"><div class="label">í˜„ì¬</div><div class="val" id="curr-val">0Â°</div></div>
    <div class="stat-box" style="border-color: var(--green);"><div class="label">ì˜¤ì°¨</div><div class="val" id="diff-val">0Â°</div></div>
</div>

<div class="view-container">
    <video id="input_video" playsinline muted crossorigin="anonymous"></video>
    <canvas id="output_canvas"></canvas>
</div>

<div class="ui-panel">
    <div class="file-input-group">
        <input type="file" id="video-upload" accept="video/*">
        <button onclick="useCamera()" style="padding:5px 10px; font-size:11px;">ì‹¤ì‹œê°„ ì¹´ë©”ë¼</button>
    </div>
    
    <div class="vid-controls" id="vid-ctrl" style="display:none;">
        <button id="play-pause" onclick="togglePlay()" style="width:50px;">â–¶</button>
        <input type="range" id="seek-bar" value="0" step="0.1">
    </div>

    <div class="btn-group">
        <button class="btn btn-base" onclick="setBaseline()">ğŸ“ ê¸°ì¤€ìì„¸ ë“±ë¡</button>
        <button class="btn btn-cap" onclick="captureAndLog()">ğŸ“¸ ë¶„ì„ ë°ì´í„° ê¸°ë¡</button>
    </div>
    <button class="btn btn-save" onclick="exportCSV()">ğŸ“Š ì—‘ì…€ ë°ì´í„° ì €ì¥ (CSV)</button>
</div>

<div class="log-container">
    <table>
        <thead><tr><th>íšŒì°¨</th><th>ê¸°ì¤€</th><th>ê¸°ë¡</th><th>ì˜¤ì°¨</th></tr></thead>
        <tbody id="log-body"></tbody>
    </table>
</div>

<script>
    const video = document.getElementById('input_video');
    const canvas = document.getElementById('output_canvas');
    const ctx = canvas.getContext('2d');
    const fileInput = document.getElementById('video-upload');
    const seekBar = document.getElementById('seek-bar');
    const playBtn = document.getElementById('play-pause');

    let baselineAngle = 0;
    let currentAngle = 0;
    let analysisHistory = [];
    let isVideoFile = false;

    // AI ì„¤ì •
    const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/${file}`});
    pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5 });
    pose.onResults(onResults);

    function calculateAngle(a, b, c) {
        const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
        let angle = Math.abs(radians * 180.0 / Math.PI);
        if (angle > 180.0) angle = 360 - angle;
        return Math.round(angle);
    }

    function onResults(results) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

        if (results.poseLandmarks) {
            const lm = results.poseLandmarks;
            // ì˜¤ë¥¸ìª½ íŒ” ê°ë„ ë¶„ì„ (ì–´ê¹¨ 12, íŒ”ê¿ˆì¹˜ 14, ì†ëª© 16)
            if(lm[12] && lm[14] && lm[16]) {
                currentAngle = calculateAngle(lm[12], lm[14], lm[16]);
                document.getElementById('curr-val').innerText = `${currentAngle}Â°`;
                if(baselineAngle > 0) {
                    const diff = currentAngle - baselineAngle;
                    document.getElementById('diff-val').innerText = (diff > 0 ? "+" : "") + diff + "Â°";
                }
            }
            drawConnectors(ctx, lm, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
            drawLandmarks(ctx, lm, {color: '#FF0000', radius: 3});
        }
        ctx.restore();
    }

    // ë¹„ë””ì˜¤ íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            isVideoFile = true;
            video.src = URL.createObjectURL(file);
            video.classList.remove('mirror');
            canvas.classList.remove('mirror');
            document.getElementById('vid-ctrl').style.display = 'flex';
            video.play();
        }
    });

    // ì¹´ë©”ë¼ ëª¨ë“œë¡œ ì „í™˜
    async function useCamera() {
        isVideoFile = false;
        document.getElementById('vid-ctrl').style.display = 'none';
        video.classList.add('mirror');
        canvas.classList.add('mirror');
        const stream = await navigator.mediaDevices.getUserMedia({video: true});
        video.srcObject = stream;
        video.play();
    }

    // ë¹„ë””ì˜¤ í”„ë ˆì„ ì²˜ë¦¬ ë£¨í”„
    async function processFrame() {
        if (!video.paused && !video.ended) {
            await pose.send({image: video});
        }
        requestAnimationFrame(processFrame);
    }
    video.addEventListener('play', processFrame);

    // [ë¡œì§] ì¬ìƒ/ì¼ì‹œì •ì§€
    function togglePlay() {
        if (video.paused) { video.play(); playBtn.innerText = "||"; }
        else { video.pause(); playBtn.innerText = "â–¶"; pose.send({image: video}); } // ì¼ì‹œì •ì§€ ì‹œ í•œ ë²ˆ ë” ë¶„ì„
    }

    // [ë¡œì§] íƒìƒ‰ ë°” ì¡°ì ˆ
    video.addEventListener('timeupdate', () => {
        const val = (video.currentTime / video.duration) * 100;
        seekBar.value = val;
    });
    seekBar.addEventListener('input', () => {
        const time = (seekBar.value / 100) * video.duration;
        video.currentTime = time;
        pose.send({image: video}); // ë“œë˜ê·¸í•˜ëŠ” ë™ì•ˆ ì‹¤ì‹œê°„ ë¶„ì„
    });

    function setBaseline() {
        baselineAngle = currentAngle;
        document.getElementById('base-val').innerText = `${baselineAngle}Â°`;
    }

    function captureAndLog() {
        if(baselineAngle === 0) { alert("ë¨¼ì € ê¸°ì¤€ìì„¸ë¥¼ ë“±ë¡í•˜ì„¸ìš”."); return; }
        const record = { base: baselineAngle, curr: currentAngle, diff: currentAngle - baselineAngle, time: new Date().toLocaleTimeString() };
        analysisHistory.push(record);
        const row = document.getElementById('log-body').insertRow(0);
        row.innerHTML = `<td>${analysisHistory.length}</td><td>${record.base}Â°</td><td>${record.curr}Â°</td><td>${record.diff > 0 ? "+" : ""}${record.diff}Â°</td>`;
    }

    function exportCSV() {
        let csv = "\uFEFFíšŒì°¨,ê¸°ì¤€ê°ë„,ë¶„ì„ê°ë„,ì˜¤ì°¨,ê¸°ë¡ì‹œê°„\n";
        analysisHistory.forEach((d, i) => { csv += `${i+1},${d.base},${d.curr},${d.diff},${d.time}\n`; });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "KCA_ë¹„ë””ì˜¤_ì •ë°€ë¶„ì„.csv";
        link.click();
    }
</script>
</body>
</html>
